# Copper Azure Functions

This directory contains the Azure Functions used in the Copper project. These functions provide backend services for the Copper application, including secure interaction with the Azure OpenAI Service.

## Functions

### generateCompletion

This function serves as an HTTP endpoint that accepts a prompt from the caller (the Copper app) and returns a completion generated by the Azure OpenAI Service.

#### How it works

1. Receives an HTTP POST request containing a JSON body with a "prompt" field.
2. Validates the presence of the "prompt" field in the request body.
3. Retrieves the OpenAI API key from Azure Key Vault using managed identity.
4. Sends the prompt to the Azure OpenAI Service and requests a completion.
5. Returns the generated completion text in the HTTP response.

#### Example request

```json
{
  "prompt": "What is the air speed velocity of an unladen swallow?"
}
```

### createItem

This function creates a new document in Cosmos DB containing information about a PCB design project. Saving information
in a database allows users in the Copper app to track their ongoing PCB design projects.

#### How it works

1. Receives an HTTP POST request containing a JSON body representing a PCB design project in the Copper app.
2. Creates a document in Cosmos DB with the provided information.
3. Returns the newly created document.

#### Example request

```json
{
  "version": 20241229,
  "generator": "pcbnew",
  "layers": [
    { "index": 1, "type": "fCu", "purpose": "signal" },
    { "index": 3, "type": "bCu", "purpose": "signal" }
  ],
  "components": [
    {
      "name": "SK2812",
      "layer": "fCu",
      "position": { "x": 148.5011, "y": 107.1372 },
      "reference": "U1",
      "value": "SK2812"
    }
  ]
}
```

### readItem

This function retrieves information from Cosmos DB using the unique ID provided as a query parameter.

#### How it works

1. Receives a GET request containing the `id` query parameter, which is the unique ID for the document to be retrieved.
2. Validates that the document being retrieved belongs to the user requesting the document by comparing the user ID
   in the document to the user ID from the token provided for authentication.
3. Returns the document data.

### updateItem

This function updates the content of a document in Cosmos DB matching the unique ID provided as a query parameter.

#### How it works

1. Receives a PUT request containing a JSON body that includes, at minimum, the unique ID of the document to be 
   updated.
2. Validates that the document being updated belongs to the user requesting the document by comparing the user ID
   in the document to the user ID from the token provided for authentication.
3. Updates the document according to the fields provided in the request body.
4. Returns the updated document.

#### Example request

```json
{
  "id": "261b8a6c-11bc-4ed2-b9b8-5970408566ae",
  "layers": [
    { "index": 0, "type": "fCu", "purpose": "signal" },
    { "index": 2, "type": "bCu", "purpose": "signal" },
    { "index": 3, "type": "test", "purpose": "signal" }
  ]
}
```

### deleteItem

This function is used to delete a document in Cosmos DB with a unique identifier matching the `id` value included as
a query parameter in the request.

#### How it works

1. Receives a DELETE request containing the `id` query parameter, which is the unique ID for the document to be retrieved.
2. Validates that the document being retrieved belongs to the user requesting the document by comparing the user ID
   in the document to the user ID from the token provided for authentication.
3. Deletes the corresponding document.
4. Returns a success response.

## Setup

### Prerequisites

- Node.js
- Azure Functions Core Tools
- Azure subscription
- Azure Key Vault with the OpenAI API key stored as a secret

### Installation

1. Clone the repository:

```sh
git clone https://github.com/Toglefritz/Copper.git
cd copper/copper_azure_functions
```

2. Install dependencies:

```sh
npm install
```

3. Set up environment variables:

Create a `.env` file in the `copper_azure_functions` directory with the following content:

```env
KEY_VAULT_NAME=your-key-vault-name
AZURE_OPENAI_ENDPOINT=your-openai-endpoint
```

### Running Locally

1. Start the Azure Functions runtime:

```sh
func start
```

2. Send a POST request to the function endpoint:

```sh
curl -X POST http://localhost:7071/generateCompletion -H "Content-Type: application/json" -d '{"prompt": "What is the air speed velocity of an unladen swallow?"}'
```

### Deployment

Deploy the Azure Functions to your Azure subscription:

```sh
func azure functionapp publish copperapp
```